version: "3.7"
services:
  geth:
    image: ethereum/client-go:v1.10.15
    ports:
      - "${GETH_NETWORK_PORT:-30303}:30303"
      - "${GETH_METRICS_PORT:-6060}:6060"
    entrypoint: >
      geth --${GETH_NETWORK:-mainnet} --port ${GETH_NETWORK_PORT:-30303}
           --http --http.addr 0.0.0.0 --http.port ${GETH_HTTP_RPC_PORT:-8545}
           --ws --ws.addr 0.0.0.0 --ws.port ${GETH_WS_RPC_PORT:-8546}
           --pprof --pprof.addr 0.0.0.0 --pprof.port ${GETH_METRICS_PORT:-6060}
    deploy:
      placement:
        constraints:
          - node.labels.chaindata == true
    volumes:
      - geth_data:/root/.ethereum
    healthcheck:
      test: >
        wget --no-cache -S -O-
        --header "Content-Type: application/json"
        --post-data='{"jsonrpc":2.0,"method":"web3_clientVersion","params":[],"id":1}'
        0.0.0.0:${GETH_HTTP_RPC_PORT:-8545}
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s

  nimbus_beacon_node:
    image: statusim/nimbus-eth2:amd64-latest
    restart: unless-stopped
    stop_grace_period: 1m
    networks:
      - default
      - metrics
    deploy:
      labels:
        prometheus-job: nimbus
        prometheus-port: 8008
      placement:
        constraints:
          - node.labels.chaindata == true
    ports:
      - 9000:9000/tcp
      - 9000:9000/udp
    volumes:
      - nibmus_data:/home/user/nimbus-eth2/build/data
    command: >-
      --network=prater --tcp-port=9000 --udp-port=9000 --enr-auto-update
      --data-dir=/home/user/nimbus-eth2/build/data/shared_prater_0
      --web3-url=ws://geth:${GETH_WS_RPC_PORT:-8546}
      --nat=extip:${NIMBUS_EXTERNAL_IP} --log-level=${NIMBUS_LOG_LEVEL:-INFO}
      --metrics --metrics-address=0.0.0.0 --metrics-port=8008

  teku:
    image: consensys/teku:latest
    command: >-
      --network=prater --eth1-endpoint=http://geth:${GETH_HTTP_RPC_PORT:-8545}
      --data-path=/var/lib/teku --log-destination=CONSOLE
    # ports:
      # - 9000:9000
      # - 5051:5051
    environment:
      - TEKU_REST_API_ENABLED=true
      - TEKU_P2P_PORT=9000
    volumes:
      - teku_data:/var/lib/teku
  # --validator-keys=/var/lib/teku/validator/keys:/var/lib/teku/validator/passwords

  prysm:
    volumes:
      - prysm_data:/data
      - /etc/prysm/genesis.ssz:/genesis/genesis.ssz
    ports:
      - 4000:4000
      - 13000:13000
      - 12000:12000/udp
    image: gcr.io/prysmaticlabs/prysm/beacon-chain:stable
    command: >-
      --datadir=/data --clear-db --rpc-host=0.0.0.0 --monitoring-host=0.0.0.0
      --http-web3provider=ws://geth:${GETH_WS_RPC_PORT:-8546} --prater
      --accept-terms-of-use --genesis-state=/genesis/genesis.ssz --force-clear-db

networks:
  metrics:
    external: true
    name: metrics_default

volumes:
  geth_data:
    name: geth-${GETH_NETWORK:-mainnet}-data
  nibmus_data:
    name: nimbus-prater-data
  prysm_data:
    name: prysm-prater-data
  teku_data:
    name: teku-prater-data
